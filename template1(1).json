{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"lambda and ses resource",
   "Parameters":{
      "endpoint":{
         "Type":"String"
      }
   },
   "Resources":{
      "Lambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Handler":"lambda_function.lambda_handler",
            "Role":{
               "Fn::GetAtt":[
                  "LambdaExecutionRole",
                  "Arn"
               ]
            },
            "Code":{
               "S3Bucket":"lambdacodes3",
               "S3Key":"hw4.zip"
            },
            "Environment":{
                "Variables":{"ENDPOINT_NAME":
                    {
                    "Ref": "endpoint"
                    }
                }
            },
            "MemorySize":128,
            "Runtime":"python3.8",
            "Timeout":60,
            "TracingConfig":{
               "Mode":"Active"
            }
         }
      },
      "LambdaExecutionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":"LambdaExecutionRole",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/service-role/",
            "Policies":[
               {
                  "PolicyName":"AWSLambdaBasicExecutionRole",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": "logs:CreateLogGroup",
                            "Resource": "*"
                        }
                     ]
                  }
               },
               {
                   "PolicyName":"xray-lambda-policy",
                        "PolicyDocument":{
                           "Version":"2012-10-17",
                           "Statement":[
                              {
                                 "Effect":"Allow",
                                 "Action":[
                                    "xray:PutTraceSegments",
                                    "xray:PutTelemetryRecords"
                                 ],
                                 "Resource":[
                                    "*"
                                 ]
                              }
                           ]
                        }
               },
               {
                  "PolicyName":"AmazonS3ReadOnlyAccess",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:Get*",
                              "s3:List*"
                           ],
                           "Resource":[
                              "*"
                           ]
                        }
                     ]
                  }
               },
               {
                  "PolicyName":"AmazonSESFullAccess",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "ses:*"
                           ],
                           "Resource":[
                              "*"
                           ]
                        }
                     ]
                  }
               },
               {
                  "PolicyName":"Sagemaker_endpoint_invoking",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "sagemaker:ListApps",
                              "sagemaker:ListWorkteams",
                              "sagemaker:ListCandidatesForAutoMLJob",
                              "sagemaker:ListTransformJobs",
                              "sagemaker:ListHumanTaskUis",
                              "sagemaker:ListMonitoringExecutions",
                              "sagemaker:ListTrainingJobs",
                              "sagemaker:ListExperiments",
                              "sagemaker:ListAutoMLJobs",
                              "sagemaker:ListMonitoringSchedules",
                              "sagemaker:ListHumanLoops",
                              "sagemaker:ListProcessingJobs",
                              "sagemaker:ListSubscribedWorkteams",
                              "sagemaker:ListNotebookInstances",
                              "sagemaker:ListFlowDefinitions",
                              "sagemaker:ListAlgorithms",
                              "sagemaker:ListNotebookInstanceLifecycleConfigs",
                              "sagemaker:ListTrialComponents",
                              "sagemaker:ListTrials",
                              "sagemaker:ListCompilationJobs",
                              "sagemaker:ListHyperParameterTuningJobs",
                              "sagemaker:ListModelPackages",
                              "sagemaker:ListEndpointConfigs",
                              "sagemaker:ListLabelingJobs",
                              "sagemaker:RenderUiTemplate",
                              "sagemaker:ListModels",
                              "sagemaker:ListDomains",
                              "sagemaker:ListEndpoints",
                              "sagemaker:ListCodeRepositories",
                              "sagemaker:ListUserProfiles"
                           ],
                           "Resource":[
                              "*"
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":"sagemaker:*",
                           "Resource":"arn:aws:sagemaker:*:*:endpoint/*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "EmailBucket":{
         "Type":"AWS::S3::Bucket",
         "DeletionPolicy":"Retain",
         "DependsOn":"TriggerLambdaPermission",
         "Properties":{
            "BucketName":"ass4emailbucket",
            "NotificationConfiguration":{
               "LambdaConfigurations":[
                  {
                     "Event":"s3:ObjectCreated:*",
                     "Function":{
                        "Fn::GetAtt":[
                           "Lambda",
                           "Arn"
                        ]
                     }
                  }
               ]
            }
         }
      },
      "bucketPermission":{
          "Type" : "AWS::S3::BucketPolicy",
          "DependsOn":"EmailBucket",
          "Properties":{
              "Bucket":"ass4emailbucket",
              "PolicyDocument":{
                  "Statement":[{
                      "Sid": "AllowSESPuts",
                      "Effect": "Allow",
                      "Principal": {
                          "Service": "ses.amazonaws.com"
                      },
                      "Action": "s3:PutObject",
                      "Resource": "arn:aws:s3:::ass4emailbucket/*",
                      "Condition": {
                          "StringEquals": {
                              "aws:Referer": "868147272107"
                          }
                      }
                  }]
              }
          }
      },
      "TriggerLambdaPermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:InvokeFunction",
            "FunctionName":{
               "Ref":"Lambda"
            },
            "Principal":"s3.amazonaws.com",
            "SourceAccount":{
               "Ref":"AWS::AccountId"
            },
            "SourceArn":{
               "Fn::Join":[
                  ":",
                  [
                     "arn",
                     "aws",
                     "s3",
                     "",
                     "",
                     "ass4emailbucket"
                  ]
               ]
            }
         }
      },
      "rule":{
         "Type":"AWS::SES::ReceiptRule",
         "Properties":{
            "Rule":{
               "Actions":[
                  {
                     "S3Action":{
                        "BucketName":"ass4emailbucket"
                     }
                  }
               ],
               "Enabled":true,
               "Name":"assgn4rule",
               "Recipients":[
                  "assign4.tech"
               ],
               "ScanEnabled":true
            },
            "RuleSetName":"assgn4ruleset"
         },
         "DependsOn":["ruleset","EmailBucket","bucketPermission"]
      },
      "ruleset":{
         "Type":"AWS::SES::ReceiptRuleSet",
         "Properties":{
            "RuleSetName":"assgn4ruleset"
         }
      }
   }
}
